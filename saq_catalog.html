<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View our catalogue</title>

    <!-- init firebase mega thing-->
    <script src="https://www.gstatic.com/firebasejs/7.2.2/firebase-app.js"></script>
    <!-- init firestore -->
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
    <!-- init SAQ firebase -->
    <script src="firebase_config.js"></script>
    <!-- init SAQ objects -->
    <script src="SAQ_objects.js"></script>
    <script src="SAQ_functions.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script>
        //Create a JSON array of all of the chair objects
        let chair_arr = create_chairs_array();
        //localStorage.setItem('cart_items', JSON.stringify(chair_arr));
    </script>
</head>
<body>
<div class = "jumbotron jumbotron-fluid" style = "background-color: gray; margin-bottom: 0px">
    <div class = "container"><img style = "height: 50px" src="images/home_page/iconchair.png" alt = "chair-icon">
        <h1 class="display-4" style="color: white;"> Site Title </h1></div>

    <form><div class ="form-group" style="padding: 5px"><input type="email" class="form-control" id="searchbar"
                                                               aria-describedby="search" placeholder="Search Catalouge">
        <br><div id = "ourCart" class="container" style = "background-color: grey;"><button type = "button" class="btn btn-outline-secondary" style="background-color: #3c3f41; padding: 15px; width: 100px; position: absolute; left: 70%">
            <a href="shopping_cart.html" style = "color: white"><p id = "cart"> Cart </p></a></button><div></div>
        </div>
    </div></form></div>

    <script>var the_db = firebase.firestore();</script>
    <script>
        let selectedChairs = [];
        let cartCount = 0;
        // Get a prefix based on the chair name
        function get_prefix(chair_name) {
            if (chair_name === 'the Clint') {
                return 'clint_';
            }
            else if (chair_name === 'the Fahad') {
                return 'fahad_';
            }
            else if (chair_name === 'the Em') {
                return 'em_';
            }
            else if (chair_name === 'the Neda') {
                return 'neda_';
            }
            else if (chair_name === 'the Sam') {
                return 'sam_';
            }
            else if (chair_name === 'the Chris') {
                return 'chris_';
            }
        }

        // Calculate an average
        function calculate_average(arr) {
            let sum = 0;

            for (let i = 0; i < arr.length; i++) {
                sum += arr[i];
            }

            return Math.floor(sum/arr.length);
        }

        // Get a chair from the DB
        function get_single_chair(chair_id) {
            let db_ref = the_db.collection("Chairs").doc(chair_id);

            db_ref.get().then(function(doc){
                if (doc.exists){
                    let ratings =  doc.data().ratings;
                    let options = [doc.data().firmness,  doc.data().back_support, doc.data().arms];
                    //id, name, price, comfort_options, ratings, picture
                    let chair = new Chair(doc.data().id, doc.data().name, doc.data().price, options, ratings, doc.data().picture);

                    document.getElementById('chair_name').innerHTML = chair.name;
                    document.getElementById('price').innerHTML = "$" + chair.price;
                    document.getElementById('rating').innerHTML = chair.ratings;
                    document.getElementById('pic').src = chair.picture;
                }
                else {
                    console.log("Didn't work");
                }
            }).catch(function(error) {
                console.log("Threw error " + error);
            });
        }

        function addChair(doc, name) {
            let dbRef = the_db.collection("Chairs").get().then(function (querySnapshot) {
            querySnapshot.forEach(function (doc) {
                if (doc.data().name === name) {
                    selectedChairs.push(doc.data());
                    console.log(selectedChairs);
                    cartCount ++;
                    document.getElementById('cart').innerHTML = "Cart: " + cartCount.toString();
                    console.log("works")
                }
            })
            //     .catch(function (error) {
            //     console.log("Error displaying all items");
            // })
        })
    }

        function display_catalog() {
            let db_ref = the_db.collection("clints_work"); // ToDo <----- replace with live Collection

            db_ref.get().then(function(catalog) {
               // Create a div area and put the chair into it
               catalog.forEach(function(doc){
                   let name = doc.data().name;
                   let prefix = get_prefix(name);

                   //The following code is an attempt to auto-generate the HTML
                   let div_tag = document.createElement("div");
                   div_tag.setAttribute("class", "container");
                   div_tag.setAttribute("style", "background-color: black; padding: 5px; color:white;");
                   document.body.appendChild(div_tag);

                   let table_parent = document.createElement("table");
                   table_parent.setAttribute("class", "display-4");
                   table_parent.setAttribute("style", "font-size: large");
                   div_tag.appendChild(table_parent);

                   let tr_parent = document.createElement("tr");
                   table_parent.appendChild(tr_parent);
                   let td_1 = document.createElement("td");
                   tr_parent.appendChild(td_1);

                   let table_child_1 = document.createElement("table");
                   table_child_1.setAttribute("class", "picture");
                   td_1.appendChild(table_child_1);
                   let tr_child_1 = document.createElement("tr");
                   table_child_1.appendChild(tr_child_1);
                   let td_child_1 = document.createElement('td');
                   tr_child_1.appendChild(td_child_1);
                   let chair_image = document.createElement("img");
                   chair_image.setAttribute("class", "img-fluid");
                   chair_image.setAttribute("height", "100");
                   chair_image.setAttribute("width", "100");
                   chair_image.setAttribute("id", prefix + "pic");
                   td_child_1.appendChild(chair_image);

                   let td_2 = document.createElement("td");
                   tr_parent.appendChild(td_2);
                   let table_child_2 = document.createElement("table");
                   table_child_2.setAttribute("class", "chair_info");
                   td_2.appendChild(table_child_2);

                   let specs = [prefix + "name", prefix + "comfort_options", prefix + "price", prefix + "rating"];
                   for (let i = 0; i < specs.length; i++) {
                       let tr_spec = document.createElement("tr");
                       table_child_2.appendChild(tr_spec);
                       let td_spec = document.createElement("td");
                       td_spec.setAttribute("id", specs[i]);
                       tr_spec.appendChild(td_spec);
                   }

                   let tr_add = document.createElement("tr");
                   table_child_2.appendChild(tr_add);
                   let td_add = document.createElement("td");
                   tr_add.appendChild(td_add);

                   let add_name = name.split(" ")[1];
                   add_name = add_name.charAt(0).toLowerCase() + add_name.slice(1);

                   let div_add = document.createElement("div");
                   div_add.setAttribute("id", add_name + "Add");
                   div_add.setAttribute("class", "quickadd");
                   div_add.innerHTML = "quick add";
                   td_add.appendChild(div_add);

                   // Now back to our filling of the table
                   document.getElementById(prefix + "name").innerHTML = name;
                   document.getElementById(prefix + "price").innerHTML = '$' + doc.data().price;
                   document.getElementById(prefix + "rating").innerHTML = "Average rating: " + calculate_average(doc.data().ratings);
                   document.getElementById(prefix + "pic").src = doc.data().picture;
               });

                document.getElementById("clintAdd").addEventListener("click", function() {
                    addChair("chair_0", 'the Clint');});
                document.getElementById("fahadAdd").addEventListener("click", function() {
                    addChair("chair_1", 'the Fahad');});
                document.getElementById("emAdd").addEventListener("click", function() {
                    addChair("chair_2", 'the Em');});
                document.getElementById("nedaAdd").addEventListener("click", function() {
                    addChair("chair_3", 'the Neda');});
                document.getElementById("samAdd").addEventListener("click", function() {
                    addChair("chair_4", 'the Sam');});
                document.getElementById("chrisAdd").addEventListener("click", function() {
                    addChair("chair_5", 'the Chris');});
            }).catch(function(error) {
                console.log("Error displaying all items, " + error);
            });
        }

        display_catalog();

        function filter_by_price() {
            // Use JS to loop through the chairs_array
            // and set the CSS display:none property according to the filter-criteria and the element_id

            let min_price = document.getElementById('min_price');
            let max_price = document.getElementById('max_price');

            //Set a CSS display property to hidden or visible
        }
    </script>

<script>

    document.getElementById("ourCart").addEventListener("click", function() {
        storeCart(selectedChairs);});
    function storeCart(array){
        localStorage.setItem('cartItems', JSON.stringify(array));
    }

</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>
